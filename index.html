<!DOCTYPE html>
<html lang="si">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IronShield Defender ‚Äì Day / Night</title>

<style>
:root{--p:#1a237e;--s:#d32f2f;--g:#2e7d32}
body{margin:0;font-family:Segoe UI;background:#f4f7f9;padding-bottom:160px}
.header{background:var(--p);color:#fff;padding:15px;font-weight:800;text-align:center;position:sticky;top:0}
.container{max-width:560px;margin:auto;padding:15px}
.panel{display:none;background:#fff;padding:18px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
.panel.active{display:block}
.row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eee}
.scroll{max-height:55vh;overflow:auto;border:1px solid #ddd;border-radius:8px;padding:10px}
.point{border:1px solid #ddd;border-radius:10px;padding:12px;margin-bottom:12px}
.title{font-weight:bold;color:var(--s)}
.last{font-size:11px;color:#777;font-style:italic}
select,input{width:100%;padding:10px;margin-top:6px;border-radius:6px;border:1px solid #bbb}
.btn{padding:14px;border:none;border-radius:8px;font-weight:bold;width:100%;margin-top:8px}
.auto{background:#ff9800;color:#fff}
.next{background:var(--p);color:#fff}
.wa{background:var(--g);color:#fff}
.copy{background:#555;color:#fff}
.footer{position:fixed;bottom:0;width:100%;background:#fff;padding:10px;box-shadow:0 -2px 8px rgba(0,0,0,.1)}
.badge{font-size:11px;color:#fff;background:#777;padding:2px 6px;border-radius:6px}
.shift{background:#eee;font-weight:bold;text-align:center}
</style>
</head>

<body>

<div class="header">IRONSHIELD DEFENDER ‚Äì DAY / NIGHT</div>

<div class="container">

<!-- STEP 1 -->
<div id="step1" class="panel active">
<h3>1Ô∏è‚É£ Shift & Attendance</h3>

<select id="shift" onchange="loadAttendance()">
  <option value="DAY">üåû DAY SHIFT (07.00 ‚Äì 19.00)</option>
  <option value="NIGHT">üåô NIGHT SHIFT (19.00 ‚Äì 07.00)</option>
</select>

<input placeholder="‡∂±‡∂∏ ‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂±..." onkeyup="filterNames(this.value)">
<div id="attendance" class="scroll"></div>

<button class="btn" onclick="saveAttendance()">üíæ Save This Shift Attendance</button>

<div class="footer">
<button class="btn next" onclick="goStep(2)">Next ‚ûú</button>
</div>
</div>

<!-- STEP 2 -->
<div id="step2" class="panel">
<h3>2Ô∏è‚É£ Duty Assignment</h3>
<div id="shiftLabel" class="shift"></div>

<button class="btn auto" onclick="autoAssign()">‚ú® Auto Assign</button>
<div id="points" class="scroll"></div>

<div class="footer">
<button class="btn wa" onclick="sendWA()">üì± WhatsApp</button>
<button class="btn copy" onclick="copyText()">üìã Copy</button>
<button class="btn" onclick="goStep(1)">‚¨Ö Back</button>
</div>
</div>

</div>

<script>
// ================= STAFF =================
const members = [
 {name:"OIC Dayarathna",rank:"OIC",skills:["Guard Room","Goods Receiving"],blocked:["CCTV New","CCTV Old"]},
 {name:"OIC Asanka",rank:"OIC",skills:["Main Gate","Goods Receiving"],blocked:["2B"]},
 {name:"OIC Kumara",rank:"OIC",skills:["Guard Room","Time Office"]},
 {name:"OIC Samaranayaka",rank:"OIC",skills:["CCTV Old","CCTV New"]},
 {name:"OIC Wijethunga",rank:"OIC",skills:["CCTV Old","CCTV New","Guard Room"]},
 {name:"OIC Rangana",rank:"OIC",skills:["CCTV Old","CCTV New","Goods Receiving"]},
 {name:"OIC Sampath",rank:"OIC",skills:["CCTV Old","CCTV New"]},
 {name:"OIC Suresh",rank:"OIC",skills:["Guard Room","Goods Receiving"],blocked:["2B"]},
 {name:"OIC Mendis",rank:"OIC",skills:["CCTV Old","CCTV New","Guard Room"]}
];

// ================= POINTS =================
const dutyPoints = [
 "Guard Room",
 "Goods Receiving",
 "CCTV New",
 "CCTV Old",
 "Main Gate",
 "Time Office"
];

// ================= INIT =================
function init(){
attendance.innerHTML = members.map(m=>`
<div class="row name">
  <span>${m.name} <span class="badge">${m.rank}</span></span>
  <input type="checkbox" class="att" data-name="${m.name}">
</div>`).join("");
loadAttendance();
}
init();

// ================= NAV =================
function goStep(n){
document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
document.getElementById("step"+n).classList.add("active");
if(n===2) renderPoints();
window.scrollTo(0,0);
}

// ================= FILTER =================
function filterNames(v){
document.querySelectorAll(".name").forEach(r=>{
r.style.display=r.innerText.toLowerCase().includes(v.toLowerCase())?"":"none";
});
}

// ================= ATTENDANCE =================
function saveAttendance(){
const shift = document.getElementById("shift").value;
const list=[...document.querySelectorAll(".att:checked")].map(c=>c.dataset.name);
localStorage.setItem("attendance_"+shift,JSON.stringify(list));
alert(shift+" attendance saved");
}

function loadAttendance(){
const shift=document.getElementById("shift").value;
const saved=JSON.parse(localStorage.getItem("attendance_"+shift)||"[]");
document.querySelectorAll(".att").forEach(c=>{
c.checked = saved.includes(c.dataset.name);
});
}

// ================= CORE FILTER =================
function allowed(point,people){
return people.filter(p=>{
if(p.blocked && p.blocked.includes(point)) return false;
if(!p.skills.includes(point)) return false;
return true;
});
}

// ================= RENDER POINTS =================
function renderPoints(){
const shift=document.getElementById("shift").value;
shiftLabel.innerText = "SHIFT : " + shift;

const presentNames=JSON.parse(localStorage.getItem("attendance_"+shift)||"[]");
const presentPeople=members.filter(m=>presentNames.includes(m.name));

points.innerHTML = dutyPoints.map(pt=>{
const ok=allowed(pt,presentPeople);
const last=localStorage.getItem(shift+"_last_"+pt)||"‡∂±‡∑ê‡∂≠";
return `
<div class="point">
  <div class="title">${pt}</div>
  <div class="last">Last (${shift}): ${last}</div>
  <select data-point="${pt}">
    <option value="">-- select --</option>
    ${
      ok.length
      ? ok.map(o=>`<option value="${o.name}">${o.name}</option>`).join("")
      : `<option disabled>‚ùå No suitable person</option>`
    }
  </select>
</div>`;
}).join("");
}

// ================= AUTO ASSIGN =================
function autoAssign(){
let used=[];
document.querySelectorAll("select").forEach(s=>{
const opts=[...s.options].map(o=>o.value).filter(v=>v && !used.includes(v));
if(opts[0]){
s.value=opts[0];
used.push(opts[0]);
}
});
}

// ================= TEXT =================
function buildText(){
const shift=document.getElementById("shift").value;
let t=`*IRONSHIELD DUTY ROSTER ‚Äì ${shift}*\n\n`;
document.querySelectorAll("select").forEach(s=>{
if(s.value){
t+=`üìç ${s.dataset.point} : ${s.value}\n`;
localStorage.setItem(shift+"_last_"+s.dataset.point,s.value);
}
});
return t;
}

// ================= SHARE =================
function sendWA(){
window.open("https://wa.me/?text="+encodeURIComponent(buildText()));
}
function copyText(){
navigator.clipboard.writeText(buildText());
alert("Copied");
}
</script>

</body>
</html>

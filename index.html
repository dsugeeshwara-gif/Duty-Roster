<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duty Management Pro v4.0</title>
    <style>
        :root { --primary: #2563eb; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --dark: #1e293b; --bg: #f8fafc; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        .tabs { display: flex; gap: 8px; margin-bottom: 15px; background: #eee; padding: 5px; border-radius: 8px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px; }
        .tab.active { background: var(--primary); color: white; }
        .hidden { display: none; }
        
        .admin-section { border: 1px solid #e2e8f0; padding: 15px; border-radius: 10px; margin-bottom: 20px; background: #fff; }
        .rank-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; }
        .rank-card { background: #f8fafc; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; }
        .rank-card h4 { margin: 0 0 10px 0; color: var(--primary); background: #dbeafe; padding: 5px; border-radius: 4px; text-align: center; }

        .staff-card { background: #fff; border: 1px solid #e2e8f0; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid var(--primary); }
        .point-switches { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .sw-btn { padding: 5px 8px; font-size: 11px; border: 1px solid #cbd5e1; border-radius: 4px; cursor: pointer; background: white; }
        .sw-btn.active { background: var(--success); color: white; border-color: var(--success); font-weight: bold; }
        .sw-btn.rank-active { background: #dbeafe; border-color: var(--primary); color: var(--primary); font-weight: bold; }

        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: var(--dark); color: white; padding: 12px; text-align: left; position: sticky; top: 0; }
        td { border-bottom: 1px solid #e2e8f0; padding: 10px; }
        
        .summary-box { background: #f1f5f9; padding: 15px; border-radius: 8px; margin-top: 20px; display: flex; justify-content: space-around; font-weight: bold; }
        .action-btn { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        
        select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; background: white; cursor: pointer; }
        select:disabled { background: #f1f5f9; cursor: not-allowed; }

        @media print { .tabs, .admin-section, .action-btn, .sw-btn { display: none; } .container { width: 100%; max-width: 100%; } select { border: none; appearance: none; font-weight: bold; color: black; } }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <div class="tab active" onclick="showTab('roster-tab')">රාජකාරි වගුව (Roster View)</div>
        <div class="tab" onclick="showTab('admin-tab')">පාලක පුවරුව (Admin Settings)</div>
    </div>

    <div id="roster-tab">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div style="display:flex; gap:10px;">
                <button class="shift-btn" id="btnDay" onclick="setShift('Day')" style="padding:10px 30px; border-radius:20px; cursor:pointer; font-weight:bold;">දිවා</button>
                <button class="shift-btn" id="btnNight" onclick="setShift('Night')" style="padding:10px 30px; border-radius:20px; cursor:pointer; font-weight:bold;">රාත්‍රී</button>
            </div>
            <div id="display-date" style="font-size:16px; font-weight:bold; color:var(--dark);"></div>
        </div>
        
        <table id="rosterTable">
            <thead>
                <tr>
                    <th style="width: 50px;">#</th>
                    <th>ස්ථානය (Duty Point)</th>
                    <th>නිලධාරියා තෝරන්න</th>
                </tr>
            </thead>
            <tbody id="rosterBody"></tbody>
        </table>

        <div class="summary-box" id="summaryBox"></div>
        <button class="action-btn" style="background:#059669; width:100%;" onclick="window.print()">Print Roster Report</button>
    </div>

    <div id="admin-tab" class="hidden">
        <div class="admin-section">
            <h3>1. රෑන්ක් අනුව පොයින්ට්ස් වෙන් කිරීම (Rank Rules)</h3>
            <div class="rank-grid" id="rankMappingGrid"></div>
        </div>

        <div class="admin-section">
            <h3>2. නිලධාරී නාමලේඛනය සහ පෞද්ගලික අවසර</h3>
            <button class="action-btn" onclick="loadDefaultStaff()">Load Master Staff List (39 Officers)</button>
            <div id="staffList" style="margin-top:20px;"></div>
        </div>
    </div>
</div>

<script>
    const allPoints = [
        "Guard Room - Post 01", "Guard Room - Post 02", "M/E Entry - 01", "M/E Entry - 02", 
        "Time Office", "B/C/P - Post 01", "B/C/P - Post 02", "Glass Door", "Lobby - Post 01", 
        "Lobby - Post 02", "C/P/R", "Doctors' Lift", "Pharmacy - Main", "Pharmacy - OPD", 
        "Pharmacy - Helper", "CCTV New - 01", "CCTV New - 02", "C/P/03", "C/P/04", 
        "Commercial Hostel", "Rounds - 01", "Rounds - 02", "Kitchen Stores", "Kitchen", 
        "Main Gate", "2nd Basement", "SICU", "MICU", "CCTV Old - 01", "CCTV Old - 02", 
        "Lift Lobby - 3rd Floor", "Lift Lobby - 4th Floor", "Lift Lobby - 5th Floor", 
        "Lift Lobby - 6th Floor", "Fort City", "Lady Hostel - New", "Hostal - Old", 
        "Hostal - New", "Layanal Area", "Bambalapitiya Area", "Dilan Area", "Receiving"
    ];

    const masterNames = [
        "OIC අසංක", "OIC කුමාර", "OIC සුරංජිත්", "OIC සමරනායක", "OIC දයාරත්න", "OIC සුරේෂ්", "OIC මෙන්ඩිස්", "OIC විජිතලාල්", "OIC රංගන",
        "SSO තාරක", "SSO ජයලත්", "SSO විරේශ්", "SSO රවී", "SSO අජිත්", "SSO මනූෂ", "SSO රත්නදාස",
        "LOIC රීටා", "LOIC මල්කාන්ති",
        "JSO ප්‍රසන්න", "JSO ප්‍රදීප් (නාමල්)", "JSO චන්දන", "JSO විජේරත්න", "JSO රාජ්", "JSO දිනේෂ්", "JSO රවිඳු", "JSO ලොකුබංඩා", "JSO සුනිල්", "JSO සම්පත්",
        "LSO සීලවතී", "LSO නාලනී", "LSO විමලසූරිය", "LSO නන්දනී", "LSO නන්දලතා", "LSO ඩිලානි", "LSO ශ්‍රියාලතා", "LSO ශාන්ති", "LSO නුගවෙල", "LSO චම්පිකා", "LSO පෙරේරා"
    ];

    const ranks = ["OIC", "SSO", "LOIC", "JSO", "LSO"];
    
    let staffData = JSON.parse(localStorage.getItem('duty_staff_v4')) || [];
    let rankPoints = JSON.parse(localStorage.getItem('rank_mapping_v4')) || { OIC: [], SSO: [], LOIC: [], JSO: [], LSO: [] };
    let currentShift = 'Day';

    function showTab(tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('roster-tab').classList.add('hidden');
        document.getElementById('admin-tab').classList.add('hidden');
        document.getElementById(tabId).classList.remove('hidden');
        event.currentTarget.classList.add('active');
        tabId === 'roster-tab' ? renderRoster() : renderAdmin();
    }

    function renderRankMapping() {
        const grid = document.getElementById('rankMappingGrid');
        grid.innerHTML = "";
        ranks.forEach(rank => {
            let btns = allPoints.map(p => `
                <button class="sw-btn ${rankPoints[rank] && rankPoints[rank].includes(p) ? 'rank-active' : ''}" 
                        onclick="toggleRankPoint('${rank}', '${p}')">${p}</button>
            `).join('');
            grid.innerHTML += `<div class="rank-card"><h4>${rank} Rules</h4><div class="point-switches">${btns}</div></div>`;
        });
    }

    function toggleRankPoint(rank, pt) {
        if(!rankPoints[rank]) rankPoints[rank] = [];
        rankPoints[rank] = rankPoints[rank].includes(pt) ? rankPoints[rank].filter(p => p !== pt) : [...rankPoints[rank], pt];
        localStorage.setItem('rank_mapping_v4', JSON.stringify(rankPoints));
        renderRankMapping();
    }

    function loadDefaultStaff() {
        if(confirm("සේවකයින් 39 දෙනෙකුගෙන් යුත් නාමලේඛනය ඇතුළත් කරන්නද?")) {
            staffData = masterNames.map(name => ({ name, allowedPoints: [] }));
            saveStaff(); renderAdmin();
        }
    }

    function toggleStaffPoint(sIdx, pt) {
        staffData[sIdx].allowedPoints = staffData[sIdx].allowedPoints.includes(pt) ? staffData[sIdx].allowedPoints.filter(p => p !== pt) : [...staffData[sIdx].allowedPoints, pt];
        saveStaff(); renderAdmin();
    }

    function renderAdmin() {
        renderRankMapping();
        const list = document.getElementById('staffList');
        list.innerHTML = "";
        staffData.forEach((s, i) => {
            let pBtns = allPoints.map(p => `<button class="sw-btn ${s.allowedPoints.includes(p) ? 'active' : ''}" onclick="toggleStaffPoint(${i},'${p}')">${p}</button>`).join('');
            list.innerHTML += `<div class="staff-card"><b>${s.name}</b><div class="point-switches">${pBtns}</div></div>`;
        });
    }

    function renderRoster() {
        const body = document.getElementById('rosterBody');
        body.innerHTML = "";
        let assigned = [];
        allPoints.forEach((_, i) => { let v = localStorage.getItem(`s_${currentShift}_${i}`); if(v) assigned.push(v); });

        allPoints.forEach((p, idx) => {
            const eligible = staffData.filter(s => {
                const sRank = ranks.find(r => s.name.startsWith(r));
                return (sRank && rankPoints[sRank] && rankPoints[sRank].includes(p)) || s.allowedPoints.includes(p);
            });

            let saved = localStorage.getItem(`s_${currentShift}_${idx}`) || "";
            let opts = eligible.map(s => {
                const isBusy = assigned.includes(s.name) && s.name !== saved;
                return `<option value="${s.name}" ${saved === s.name ? 'selected' : ''} ${isBusy ? 'disabled' : ''}>${s.name} ${isBusy ? '(Busy)' : ''}</option>`;
            }).join('');

            body.innerHTML += `<tr><td>${idx+1}</td><td><b>${p}</b></td><td><select onchange="localStorage.setItem('s_${currentShift}_${idx}', this.value); renderRoster();"><option value="">-- නිලධාරියා තෝරන්න --</option>${opts}</select></td></tr>`;
        });
        updateSummary();
        updateShiftUI();
    }

    function updateSummary() {
        let c = { OIC: 0, SSO: 0, LOIC:0, JSO: 0, LSO: 0 };
        allPoints.forEach((_, i) => { 
            let n = localStorage.getItem(`s_${currentShift}_${i}`); 
            ranks.forEach(r => { if(n && n.startsWith(r)) c[r]++; });
        });
        document.getElementById('summaryBox').innerHTML = Object.entries(c).map(([r, v]) => `<div><div style="font-size:22px; color:var(--primary);">${v}</div><div style="font-size:12px; color:#666;">${r}</div></div>`).join('');
    }

    function setShift(s) { currentShift = s; renderRoster(); }
    function updateShiftUI() {
        document.getElementById('btnDay').className = (currentShift === 'Day' ? 'shift-btn active' : 'shift-btn');
        document.getElementById('btnNight').className = (currentShift === 'Night' ? 'shift-btn active' : 'shift-btn');
    }
    function saveStaff() { localStorage.setItem('duty_staff_v4', JSON.stringify(staffData)); }
    
    document.getElementById('display-date').innerText = new Date().toLocaleDateString('si-LK', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
    renderRoster();
</script>
</body>
</html>
